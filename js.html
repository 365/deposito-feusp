<script>
    const btnProximo = document.getElementById('btn-proximo-etapa1');
    const progressBar = document.getElementById('progress-bar');

    // 1. CONSULTA DE DISPONIBILIDADE
    document.getElementById('btn-consultar').addEventListener('click', function () {
        const dataVal = document.getElementById('dataDeposito').value;
        const horaVal = document.getElementById('horaDeposito').value;

        if (!dataVal || !horaVal) {
            criarNotificacaoAdvertencia("Por favor, preencha Data e Horﾃ｡rio.", "Dados Incompletos");
            return;
        }

        toggleLoading(true, "Consultando agenda...");

        google.script.run
            .withSuccessHandler(function (res) {
                toggleLoading(false);
                if (res && res.disponivel) {
                    mostrarModalDecisao(res.mensagem, "Data Disponﾃｭvel", "sucesso");
                } else {
                    mostrarModalDecisao(res.mensagem || "Data lotada", "Agenda Cheia", "erro");
                }
            })
            .withFailureHandler(function (err) {
                toggleLoading(false);
                criarNotificacaoErro(err.message, "Erro Crﾃｭtico");
            })
            .consultarDisponibilidadeData(dataVal);
    });

    // 2. FUNﾃﾃグ DO MODAL (CORRIGIDA)
    // 2. FUNﾃﾃグ DO MODAL (CORRIGIDA)
    function mostrarModalDecisao(mensagem, titulo, tipo) {
        const modalElement = document.getElementById('modalResultado');
        const header = document.getElementById('modalHeaderCor');
        const icone = document.getElementById('modalIcone');
        const txtTitulo = document.getElementById('modalTituloText');
        const txtMensagem = document.getElementById('modalMensagem');
        const btnAgendar = document.getElementById('btnModalAgendar');
        const btnVoltar = document.getElementById('btnModalVoltar');
        const pergunta = document.getElementById('perguntaAgendamento');
        const detalhesFinal = document.getElementById('detalhesAgendamentoFinal'); // ADICIONADO ESTA LINHA QUE FALTAVA

        // Reset inicial dos elementos
        pergunta.style.display = 'none';
        btnAgendar.style.display = 'none';
        detalhesFinal.classList.add('d-none'); // Agora nﾃ｣o vai mais dar erro aqui
        btnVoltar.textContent = "Voltar";
        btnVoltar.style.display = 'inline-block';

        // Reset de cores do Header
        header.classList.remove('bg-success', 'bg-danger', 'bg-sucesso-modal', 'bg-erro-modal');

        if (tipo === 'sucesso') {
            header.classList.add('bg-sucesso-modal');
            icone.className = 'bi bi-calendar-check-fill me-2';
            txtTitulo.textContent = titulo;
            txtMensagem.innerHTML = mensagem;
            pergunta.style.display = 'block';
            btnAgendar.style.display = 'inline-block';
        } else {
            header.classList.add('bg-erro-modal');
            icone.className = 'bi bi-calendar-x-fill me-2';
            txtTitulo.textContent = "Data Indisponﾃｭvel";
            txtMensagem.innerHTML = `<span class="fw-bold text-danger">Atenﾃｧﾃ｣o!</span><br>${mensagem}<br><br>Por favor, escolha outro dia.`;
            btnAgendar.style.display = 'none';
            btnVoltar.textContent = "Entendido";
        }

        // Criar e mostrar a instﾃ｢ncia do modal
        const instanciaModal = new bootstrap.Modal(modalElement);

        // EVENTO DE CLIQUE NO BOTﾃグ AGENDAR
        btnAgendar.onclick = function () {
            const dados = {
                nome: document.getElementById('nome').value,
                nrUsp: document.getElementById('nrUsp').value,
                emailUSP: document.getElementById('emailUSP').value,
                tituloTese: document.getElementById('tituloTese').value,
                dataDeposito: document.getElementById('dataDeposito').value,
                horaDeposito: document.getElementById('horaDeposito').value
            };

            if (!dados.nome || !dados.tituloTese) {
                instanciaModal.hide();
                criarNotificacaoAdvertencia("Preencha Nome e Tﾃｭtulo da Tese antes de agendar.", "Campos Faltando");
                return;
            }

            txtMensagem.innerHTML = `Aguarde, agendando para <strong>${dados.nome}</strong>...`;
            pergunta.style.display = 'none';
            btnAgendar.style.display = 'none';
            btnVoltar.style.display = 'none';
            toggleLoading(true, "Finalizando agendamento...");

            google.script.run
                .withSuccessHandler(function (res) {
                    toggleLoading(false);
                    if (res.sucesso) {
                        header.classList.remove('bg-sucesso-modal');
                        header.classList.add('bg-info-modal');
                        txtTitulo.textContent = "Agendamento Confirmado!";
                        txtMensagem.innerHTML = `<strong>${res.nome}</strong>, agendamento realizado com sucesso!`;

                        // Trava campos
                        document.getElementById('btn-consultar').disabled = true;
                        const campos = ['nome', 'nrUsp', 'emailUSP', 'tituloTese', 'dataDeposito', 'horaDeposito'];
                        campos.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.readOnly = true;
                        });

                        detalhesFinal.innerHTML = `
                            <p class="mb-1 small">套 <strong>Data:</strong> ${res.data}</p>
                            <p class="mb-1 small">竢ｰ <strong>Horﾃ｡rio:</strong> ${res.hora}</p>
                            <p class="mb-0 small">当 <strong>Tﾃｭtulo:</strong> ${res.titulo}</p>
                        `;
                        detalhesFinal.classList.remove('d-none');

                        btnVoltar.textContent = "Fechar e Prosseguir";
                        btnVoltar.style.display = 'inline-block';
                        btnProximo.disabled = false;
                    }
                })
                .processarAgendamento(dados);
        };

        instanciaModal.show();
    }

    // 3. NAVEGAﾃﾃグ E AUXILIARES
    document.getElementById('dataDeposito').addEventListener('change', () => btnProximo.disabled = true);
    document.getElementById('horaDeposito').addEventListener('change', () => btnProximo.disabled = true);

    document.getElementById('btn-proximo-etapa1').addEventListener('click', function () {
        document.getElementById('step-1').classList.add('d-none');
        document.getElementById('step-2').classList.remove('d-none');
        progressBar.style.width = '100%';
    });

    document.getElementById('btn-voltar-etapa2').addEventListener('click', function () {
        document.getElementById('step-2').classList.add('d-none');
        document.getElementById('step-1').classList.remove('d-none');
        progressBar.style.width = '33%';
    });

    function toggleLoading(show, texto = "Carregando...") {
        const overlay = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingTexto');
        if (txt) txt.textContent = texto;
        overlay.classList.toggle('d-none', !show);
        overlay.classList.toggle('d-flex', show);
    }

    function criarNotificacao(mensagem, titulo) {
        document.getElementById('mensagemNotificacao').textContent = mensagem;
        document.getElementById('tituloNotificacao').textContent = titulo;
        bootstrap.Toast.getOrCreateInstance(document.getElementById('notificacao')).show();
    }
    function criarNotificacaoOK(m, t) { criarNotificacao(m, t); definirIcone('bi-check2-square'); definirCor('--verde-sucesso'); }
    function criarNotificacaoErro(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-triangle-fill'); definirCor('--vermelho-feusp'); }
    function criarNotificacaoAdvertencia(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-square'); definirCor('--amarelo'); }
    function definirIcone(c) { document.getElementById('iconeNotificacao').className = 'bi ' + c; }
    function definirCor(v) {
        let cor = getComputedStyle(document.documentElement).getPropertyValue(v).trim();
        document.getElementById('notificacao').style.backgroundColor = cor;
    }
</script>