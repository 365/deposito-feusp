<script>
    const btnProximo = document.getElementById('btn-proximo-etapa1');
    const progressBar = document.getElementById('progress-bar');

    // 1. CONSULTA DE DISPONIBILIDADE (ATUALIZADO)
document.getElementById('btn-consultar').addEventListener('click', function () {
    const dataVal = document.getElementById('dataDeposito').value;
    const horaVal = document.getElementById('horaDeposito').value;

    if (!dataVal || !horaVal) {
        criarNotificacaoAdvertencia("Por favor, preencha Data e Hor√°rio.", "Dados Incompletos");
        return;
    }

    toggleLoading(true, "Consultando agenda...");

    google.script.run
        .withSuccessHandler(function (res) {
            toggleLoading(false);
            if (res && res.disponivel) {
                // DISPON√çVEL - Modal verde
                mostrarModalDecisao(res.mensagem, "Data Dispon√≠vel", "sucesso");
            } else {
                // INDISPON√çVEL - Modal vermelho (mensagem j√° vem completa do backend)
                mostrarModalDecisao(res.mensagem, "Per√≠odo Indispon√≠vel", "erro");
            }
        })
        .withFailureHandler(function (err) {
            toggleLoading(false);
            criarNotificacaoErro(err.message, "Erro Cr√≠tico");
        })
        .consultarDisponibilidadeData(dataVal, horaVal);
});

    // 2. FUN√á√ÉO DO MODAL (CORRIGIDA)
    function mostrarModalDecisao(mensagem, titulo, tipo) {
        const modalElement = document.getElementById('modalResultado');
        const header = document.getElementById('modalHeaderCor');
        const icone = document.getElementById('modalIcone');
        const txtTitulo = document.getElementById('modalTituloText');
        const txtMensagem = document.getElementById('modalMensagem');
        const btnAgendar = document.getElementById('btnModalAgendar');
        const btnVoltar = document.getElementById('btnModalVoltar');
        const pergunta = document.getElementById('perguntaAgendamento');
        const detalhesFinal = document.getElementById('detalhesAgendamentoFinal'); // ADICIONADO ESTA LINHA QUE FALTAVA

        // Reset inicial dos elementos
        pergunta.style.display = 'none';
        btnAgendar.style.display = 'none';
        detalhesFinal.classList.add('d-none'); // Agora n√£o vai mais dar erro aqui
        btnVoltar.textContent = "Voltar";
        btnVoltar.style.display = 'inline-block';

        // Reset de cores do Header
        header.classList.remove('bg-success', 'bg-danger', 'bg-sucesso-modal', 'bg-erro-modal');

        if (tipo === 'sucesso') {
            header.classList.add('bg-sucesso-modal');
            icone.className = 'bi bi-calendar-check-fill me-2';
            txtTitulo.textContent = titulo;
            txtMensagem.innerHTML = mensagem;
            pergunta.style.display = 'block';
            btnAgendar.style.display = 'inline-block';
        } else {
            header.classList.add('bg-erro-modal');
            icone.className = 'bi bi-calendar-x-fill me-2';
            txtTitulo.textContent = "Data Indispon√≠vel";
            txtMensagem.innerHTML = `<span class="fw-bold text-danger">Aten√ß√£o!</span><br>${mensagem}<br><br>`;
            btnAgendar.style.display = 'none';
            btnVoltar.textContent = "Entendido";
        }

        // Criar e mostrar a inst√¢ncia do modal
        const instanciaModal = new bootstrap.Modal(modalElement);

        // EVENTO DE CLIQUE NO BOT√ÉO AGENDAR
        btnAgendar.onclick = function () {
            const dados = {
                nome: document.getElementById('nome').value,
                nrUsp: document.getElementById('nrUsp').value,
                emailUSP: document.getElementById('emailUSP').value,
                tituloTese: document.getElementById('tituloTese').value,
                dataDeposito: document.getElementById('dataDeposito').value,
                horaDeposito: document.getElementById('horaDeposito').value
            };

            if (!dados.nome || !dados.tituloTese) {
                instanciaModal.hide();
                criarNotificacaoAdvertencia("Preencha Nome e T√≠tulo da Tese antes de agendar.", "Campos Faltando");
                return;
            }

            txtMensagem.innerHTML = `Aguarde, agendando para <strong>${dados.nome}</strong>...`;
            pergunta.style.display = 'none';
            btnAgendar.style.display = 'none';
            btnVoltar.style.display = 'none';
            toggleLoading(true, "Finalizando agendamento...");

            google.script.run
                .withSuccessHandler(function (res) {
                    toggleLoading(false);
                    if (res.sucesso) {
                        header.classList.remove('bg-sucesso-modal');
                        header.classList.add('bg-info-modal');
                        txtTitulo.textContent = "Agendamento Confirmado!";
                        txtMensagem.innerHTML = `<strong>${res.nome}</strong>, agendamento realizado com sucesso!`;

                        // Trava campos
                        document.getElementById('btn-consultar').disabled = true;
                        const campos = ['nome', 'nrUsp', 'emailUSP', 'tituloTese', 'dataDeposito', 'horaDeposito'];
                        campos.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.readOnly = true;
                        });

                        detalhesFinal.innerHTML = `
                            <p class="mb-1 small">üìÖ <strong>Data:</strong> ${res.data}</p>
                            <p class="mb-1 small">‚è∞ <strong>Hor√°rio:</strong> ${res.hora}</p>
                            <p class="mb-0 small">üìñ <strong>T√≠tulo:</strong> ${res.titulo}</p>
                        `;
                        detalhesFinal.classList.remove('d-none');

                        btnVoltar.textContent = "Fechar e Prosseguir";
                        btnVoltar.style.display = 'inline-block';
                        btnProximo.disabled = false;
                    }
                })
                .processarAgendamento(dados);
        };

        instanciaModal.show();
    }

    // Fun√ß√£o para carregar os orientadores no select
    // No in√≠cio do seu script ou dentro do evento do bot√£o Pr√≥ximo
    function carregarOrientadores() {
        const select = document.getElementById('orientador');
        if (!select) return;

        google.script.run
            .withSuccessHandler(function (lista) {
                select.innerHTML = '<option value="" selected disabled>Selecione o Orientador...</option>';
                if (lista && lista.length > 0) {
                    lista.forEach(nome => {
                        let opt = document.createElement('option');
                        opt.value = nome;
                        opt.textContent = nome;
                        select.appendChild(opt);
                    });
                }
            })
            .listarOrientadores();
    }

    // Chamar ao carregar a p√°gina
    window.addEventListener('load', carregarOrientadores);

    // 3. NAVEGA√á√ÉO E AUXILIARES
    document.getElementById('dataDeposito').addEventListener('change', () => btnProximo.disabled = true);
    document.getElementById('horaDeposito').addEventListener('change', () => btnProximo.disabled = true);

document.getElementById('btn-proximo-etapa1').addEventListener('click', function () {
    document.getElementById('step-1').classList.add('d-none');
    document.getElementById('step-2').classList.remove('d-none');
    progressBar.style.width = '66%';

    // SCROLL OTIMIZADO - Aguarda renderiza√ß√£o e rola para o topo do formul√°rio
    setTimeout(() => {
        const container = document.getElementById('form-container');
        const headerHeight = document.querySelector('.sticky-top').offsetHeight;
        const offset = headerHeight + 20; // 20px de margem extra
        
        const elementPosition = container.getBoundingClientRect().top + window.pageYOffset;
        const offsetPosition = elementPosition - offset;

        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }, 100);
});

    document.getElementById('btn-voltar-etapa2').addEventListener('click', function () {
        document.getElementById('step-2').classList.add('d-none');
        document.getElementById('step-1').classList.remove('d-none');
        progressBar.style.width = '33%';
        carregarOrientadores();
    });

    function toggleLoading(show, texto = "Carregando...") {
        const overlay = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingTexto');
        if (txt) txt.textContent = texto;
        overlay.classList.toggle('d-none', !show);
        overlay.classList.toggle('d-flex', show);
    }

    function criarNotificacao(mensagem, titulo) {
        document.getElementById('mensagemNotificacao').textContent = mensagem;
        document.getElementById('tituloNotificacao').textContent = titulo;
        bootstrap.Toast.getOrCreateInstance(document.getElementById('notificacao')).show();
    }
    function criarNotificacaoOK(m, t) { criarNotificacao(m, t); definirIcone('bi-check2-square'); definirCor('--verde-sucesso'); }
    function criarNotificacaoErro(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-triangle-fill'); definirCor('--vermelho-feusp'); }
    function criarNotificacaoAdvertencia(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-square'); definirCor('--amarelo'); }
    function definirIcone(c) { document.getElementById('iconeNotificacao').className = 'bi ' + c; }
    function definirCor(v) {
        let cor = getComputedStyle(document.documentElement).getPropertyValue(v).trim();
        document.getElementById('notificacao').style.backgroundColor = cor;
    }


    /**
     * Mostra/Esconde campos de log√≠stica (Di√°ria/Passagem)
     */
    function toggleLogistica(id, mostrar) {
        const divLogistica = document.getElementById('logistica' + id);
        if (mostrar) {
            divLogistica.classList.remove('d-none');
        } else {
            divLogistica.classList.add('d-none');
            // Limpa as sele√ß√µes internas se esconder
            resetCamposLogistica(id);
        }
    }

    /**
     * Mostra/Esconde campo de Upload e Passagens
     */
    function toggleUpload(id, mostrar) {
        const divUpload = document.getElementById('campoUpload' + id);
        if (mostrar) {
            divUpload.classList.remove('d-none');
        } else {
            divUpload.classList.add('d-none');
        }
    }

    function resetCamposLogistica(id) {
        document.getElementById('diaria' + id + 'Sim').checked = false;
        document.getElementById('diaria' + id + 'Nao').checked = false;
        document.getElementById('campoUpload' + id).classList.add('d-none');
    }
</script>