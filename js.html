<script>
    // --- 1. TOPO DO ARQUIVO (AQUI voc√™ cria o objeto) ---
    // Objeto criaddo para captura dos dados do aluno
    //const dadosAluno = {}; // Ele come√ßa vazio, como uma pasta pronta para receber pap√©is
    window.dadosAluno = {};

    const btnProximo = document.getElementById('btn-proximo-etapa1');
    const progressBar = document.getElementById('progress-bar');

/** =================================
     0. MOSTRAR E ESCONDER AS STEPS
    ================================= */
    function mostrarEtapa(etapa) {
        // Esconde TODAS as se√ß√µes
        document.querySelectorAll('.step-section').forEach(section => {
            section.classList.add('d-none');
        });
        
        // Mostra a etapa atual
        const proximaEtapa = document.getElementById('step-' + etapa);
        if (proximaEtapa) {
            proximaEtapa.classList.remove('d-none');
        }

        // Scroll para o topo para evitar que o usu√°rio "caia" no meio da p√°gina
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

/** =============================================
     1. CONSULTA DE DISPONIBILIDADE (ATUALIZADO)
    ============================================= */
    document.getElementById('btn-consultar').addEventListener('click', function () {
        const dataVal = document.getElementById('dataAgenda').value;
        const horaVal = document.getElementById('horaAgenda').value;

        if (!dataVal || !horaVal) {
            criarNotificacaoAdvertencia("Por favor, preencha Data e Hor√°rio.", "Dados Incompletos");
            return;
        }

        toggleLoading(true, "Consultando agenda...");

        google.script.run
            .withSuccessHandler(function (res) {
                toggleLoading(false);
                if (res && res.disponivel) {
                    // DISPON√çVEL - Modal verde
                    mostrarModalDecisao(res.mensagem, "Data Dispon√≠vel", "sucesso");
                } else {
                    // INDISPON√çVEL - Modal vermelho (mensagem j√° vem completa do backend)
                    mostrarModalDecisao(res.mensagem, "Per√≠odo Indispon√≠vel", "erro");
                }
            })
            .withFailureHandler(function (err) {
                toggleLoading(false);
                criarNotificacaoErro(err.message, "Erro Cr√≠tico");
            })
            .consultarDisponibilidadeData(dataVal, horaVal);
    });

/** =============================================
     VALIDADOR EMAIL GLOBAL (toast nativo)
    ============================================= */
    function validarEmail(campoId) {
        const campo = document.getElementById(campoId);
        const label = campo.previousElementSibling ? campo.previousElementSibling.textContent.trim() : 'E-mail';
        const email = campo.value.trim();
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        
        // Remove classes antigas
        campo.classList.remove('is-valid', 'is-invalid');
        
        if (email === '') return true;  // Vazio OK
        
        if (regex.test(email)) {
            campo.classList.add('is-valid');  // Verde
            return true;
        } else {
            campo.classList.add('is-invalid');  // Vermelho
            // TOAST EXISTENTE (amarelo)
            criarNotificacaoAdvertencia(
                `E-mail inv√°lido: "${label}". Use formato exemplo@dominio.com`, 
                'Formato inv√°lido'
            );
            return false;
        }
    }

/** ===================================
     2. FUN√á√ÉO DO MODAL (CORRIGIDA)
    =================================== */
    function mostrarModalDecisao(mensagem, titulo, tipo) {
        const modalElement = document.getElementById('modalResultado');
        const header = document.getElementById('modalHeaderCor');
        const icone = document.getElementById('modalIcone');
        const txtTitulo = document.getElementById('modalTituloText');
        const txtMensagem = document.getElementById('modalMensagem');
        const btnAgendar = document.getElementById('btnModalAgendar');
        const btnVoltar = document.getElementById('btnModalVoltar');
        const pergunta = document.getElementById('perguntaAgendamento');
        const detalhesFinal = document.getElementById('detalhesAgendamentoFinal'); // ADICIONADO ESTA LINHA QUE FALTAVA

        // Reset inicial dos elementos
        pergunta.style.display = 'none';
        btnAgendar.style.display = 'none';
        detalhesFinal.classList.add('d-none'); // Agora n√£o vai mais dar erro aqui
        btnVoltar.textContent = "Voltar";
        btnVoltar.style.display = 'inline-block';

        // Reset de cores do Header
        header.classList.remove('bg-success', 'bg-danger', 'bg-sucesso-modal', 'bg-erro-modal');

        if (tipo === 'sucesso') {
            header.classList.add('bg-sucesso-modal');
            icone.className = 'bi bi-calendar-check-fill me-2';
            txtTitulo.textContent = titulo;
            txtMensagem.innerHTML = mensagem;
            pergunta.style.display = 'block';
            btnAgendar.style.display = 'inline-block';
        } else {
            header.classList.add('bg-erro-modal');
            icone.className = 'bi bi-calendar-x-fill me-2';
            txtTitulo.textContent = "Data Indispon√≠vel";
            txtMensagem.innerHTML = `<span class="fw-bold text-danger">Aten√ß√£o!</span><br>${mensagem}<br><br>`;
            btnAgendar.style.display = 'none';
            btnVoltar.textContent = "Entendido";
        }

        // Criar e mostrar a inst√¢ncia do modal
        const instanciaModal = new bootstrap.Modal(modalElement);

    /** ===================================
         EVENTO DE CLIQUE NO BOT√ÉO AGENDAR
        =================================== */
        btnAgendar.onclick = function () {

        // Gravando direto no objeto que est√° l√° no topo do seu script
            dadosAluno.nome         = document.getElementById('nome').value;
            dadosAluno.nrUsp        = document.getElementById('nrUsp').value;
            dadosAluno.emailAluno   = document.getElementById('emailAluno').value;
            dadosAluno.tituloTese   = document.getElementById('tituloTese').value;
            dadosAluno.dataAgenda   = document.getElementById('dataAgenda').value;
            dadosAluno.horaAgenda   = document.getElementById('horaAgenda').value;

            console.log('‚úÖ Dados salvos no objeto global:', dadosAluno);

            if (!dadosAluno.nome || !dadosAluno.tituloTese) {
                instanciaModal.hide();
                criarNotificacaoAdvertencia("Preencha Nome e T√≠tulo da Tese antes de agendar.", "Campos Faltando");
                return;
            }

            txtMensagem.innerHTML = `Aguarde, agendando para <strong>${dadosAluno.nome}</strong>...`;
            pergunta.style.display = 'none';
            btnAgendar.style.display = 'none';
            btnVoltar.style.display = 'none';
            toggleLoading(true, "Finalizando agendamento...");

            google.script.run
                .withSuccessHandler(function (res) {
                    toggleLoading(false);
                    if (res.sucesso) {
                        header.classList.remove('bg-sucesso-modal');
                        header.classList.add('bg-info-modal');
                        txtTitulo.textContent = "Agendamento Confirmado!";
                        txtMensagem.innerHTML = `<strong>${res.nome}</strong>, agendamento realizado com sucesso!`;

                        // Trava campos
                        document.getElementById('btn-consultar').disabled = true;
                        const campos = ['nome', 'nrUsp', 'emailAluno', 'tituloTese', 'dataAgenda', 'horaAgenda'];
                        campos.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.readOnly = true;
                        });

                        detalhesFinal.innerHTML = `
                            <p class="mb-1 small">üìÖ <strong>Data:</strong> ${res.data}</p>
                            <p class="mb-1 small">‚è∞ <strong>Hor√°rio:</strong> ${res.hora}</p>
                            <p class="mb-0 small">üìñ <strong>T√≠tulo:</strong> ${res.titulo}</p>
                        `;
                        detalhesFinal.classList.remove('d-none');

                        btnVoltar.textContent = "Fechar e Prosseguir";
                        btnVoltar.style.display = 'inline-block';
                        btnProximo.disabled = false;
                    }
                })
                .processarAgendamento(dadosAluno);
        };

        instanciaModal.show();
    }

/** ================================================
     Fun√ß√£o para carregar os orientadores no select
    ================================================ */
    // No in√≠cio do seu script ou dentro do evento do bot√£o Pr√≥ximo
    function carregarOrientadores() {
        const select = document.getElementById('orientador');
        if (!select) return;

        const valorSalvo = window.orientadorSelecionado || '';

        google.script.run
            .withSuccessHandler(function (lista) {
                select.innerHTML = '<option value="" selected disabled>Selecione o Orientador...</option>';
                if (lista && lista.length > 0) {
                    lista.forEach(nome => {
                        let opt = document.createElement('option');
                        opt.value = nome;
                        opt.textContent = nome;
                        select.appendChild(opt);
                    });
                }
                // ‚Üê RESTAURAR SELE√á√ÉO
                if (valorSalvo) {
                    select.value = valorSalvo;
                }
            })
            .listarOrientadores();
    }

    // Chamar ao carregar a p√°gina
    window.addEventListener('load', carregarOrientadores);

/** =============================
     3. NAVEGA√á√ÉO E AUXILIARES
    ============================= */
    document.getElementById('dataAgenda').addEventListener('change', () => btnProximo.disabled = true);
    document.getElementById('horaAgenda').addEventListener('change', () => btnProximo.disabled = true);

    document.getElementById('btn-proximo-etapa1').addEventListener('click', function () {
        //document.getElementById('step-1').classList.add('d-none');

        // SALVA STEP-1 AQUI üëá
        window.dadosAluno.nome = document.getElementById('nome').value;
        window.dadosAluno.nrUsp = document.getElementById('nrUsp').value;
        window.dadosAluno.emailAluno = document.getElementById('emailAluno').value;
        window.dadosAluno.tituloTese = document.getElementById('tituloTese').value;
        window.dadosAluno.dataAgenda = document.getElementById('dataAgenda').value;
        window.dadosAluno.horaAgenda = document.getElementById('horaAgenda').value;
        console.log('‚úÖ STEP-1 SALVO:', window.dadosAluno.nome);

        //document.getElementById('step-2').classList.remove('d-none');
        mostrarEtapa(2);
        progressBar.style.width = '25%';

        // SCROLL OTIMIZADO - Aguarda renderiza√ß√£o e rola para o topo do formul√°rio
        setTimeout(() => {
            const container = document.getElementById('form-container');
            const headerHeight = document.querySelector('.sticky-top').offsetHeight;
            const offset = headerHeight + 20; // 20px de margem extra

            const elementPosition = container.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - offset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }, 100);
    });

    document.getElementById('btn-voltar-etapa2').addEventListener('click', function () {
    // ‚Üê SALVAR ORIENTADOR antes de esconder
        window.orientadorSelecionado = document.getElementById('orientador').value;

        //document.getElementById('step-2').classList.add('d-none');
        //document.getElementById('step-1').classList.remove('d-none');
        mostrarEtapa(1);
        progressBar.style.width = '25%';
        carregarOrientadores();
    });

/** =============================
     ETAPA 2 ‚Üí ETAPA 3 (CORRETO)
    ============================= */
    document.getElementById('btn-proximo-etapa2').addEventListener('click', function () {
        //document.getElementById('step-2').classList.add('d-none');
        //document.getElementById('step-3').classList.remove('d-none');
        //document.getElementById('progress-bar').style.width = '50%';
        salvarDadosEtapa(2);
        mostrarEtapa(3);

        progressBar.style.width = '50%'; // <-- Mude aqui (est√° 66%)

        // ‚Üê Scroll da pagina para iniciar no topo (c√≥pia da etapa1)
        setTimeout(() => {
            const container = document.getElementById('form-container');
            const headerHeight = document.querySelector('.sticky-top').offsetHeight;
            const offset = headerHeight + 20;  // 20px margem
            const elementPosition = container.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - offset;
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }, 100);
    });

/** =============================
     ETAPA 3 ‚Üí ETAPA 2 (CORRETO)
    ============================= */
    document.getElementById('btn-voltar-etapa3').addEventListener('click', function () {
        //document.getElementById('step-3').classList.add('d-none');
        //document.getElementById('step-2').classList.remove('d-none');
        const btnVoltar3 = document.getElementById('btn-voltar-etapa3');

        
        salvarDadosEtapa(3);
        mostrarEtapa(2);
        progressBar.style.width = '50%';


        if (btnVoltar3) {
            console.log("üîç DEBUG: Bot√£o Voltar-Etapa3 encontrado no HTML!");

            btnVoltar3.addEventListener('click', function (e) {
                console.log("üöÄ DEBUG: Voc√™ CLICOU no bot√£o Voltar!");
                
                try {
                    mostrarEtapa(2);
                    console.log("‚úÖ DEBUG: Fun√ß√£o mostrarEtapa(2) executada.");
                    
                    if (document.getElementById('progress-bar')) {
                        document.getElementById('progress-bar').style.width = '50%';
                    }

                    // Scroll
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (erro) {
                    console.error("‚ùå DEBUG: Erro ao tentar voltar:", erro);
                }
            });
        } else {
            console.error("‚ö†Ô∏è DEBUG: O bot√£o 'btn-voltar-etapa3' N√ÉO existe no HTML desta p√°gina.");
        }


        // ‚Üê Scroll da pagina para iniciar no topo (c√≥pia da etapa1)
        setTimeout(() => {
            const container = document.getElementById('form-container');
            const headerHeight = document.querySelector('.sticky-top').offsetHeight;
            const offset = headerHeight + 20;
            const elementPosition = container.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - offset;
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }, 100);
    });

/** =============================
     ETAPA 3 ‚Üí ETAPA 4 (FINAL)
    ============================= */
    document.addEventListener('DOMContentLoaded', function() {
        const btnStep4 = document.getElementById('btn-proximo-etapa3');

        if (btnStep4) {
            btnStep4.addEventListener('click', function() {
                console.log('üî• CLIQUE step-4');
                
                // 1. Muda a tela

                salvarDadosEtapa(3);
                mostrarEtapa(4);

                // 2. Alimenta o resumo usando a fun√ß√£o centralizada (Evita duplicar!)
                setTimeout(() => {
                    atualizarResumoFinal(); 
                }, 150);
                
                // 3. UI: Barra de progresso e Scroll
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) progressBar.style.width = '100%';
                
                setTimeout(() => {
                    const container = document.getElementById('form-container');
                    if(container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 200);
                
                console.log('‚úÖ STEP-4 CARREGADA');
            });
            console.log('Evento step-4 ATIVO!');
        }
    });

/** ===============================
    ETAPA 4 ‚Üí ETAPA 3 (VOLTAR)
=============================== */
    // 1. Ajustado para o ID correto: btn-voltar-etapa4
    document.getElementById('btn-voltar-etapa4').addEventListener('click', function () {
        
        salvarDadosEtapa(4);
        mostrarEtapa(3);
        
        // 2. Ajustado para buscar o elemento da barra na hora
        const pb = document.getElementById('progress-bar');
        if (pb) pb.style.width = '75%'; // 75% √© o progresso da Etapa 3

        // Scroll da pagina (Seu c√°lculo de offset est√° √≥timo!)
        setTimeout(() => {
            const container = document.getElementById('form-container');
            const headerElement = document.querySelector('.sticky-top');
            const headerHeight = headerElement ? headerElement.offsetHeight : 0;
            const offset = headerHeight + 20;
            const elementPosition = container.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - offset;
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }, 100);
    });

/** ==================================================
 *  CALCULA FORMATO DEFESA DE TESE (APENAS TITULARES)
 * =================================================== */
    function calcularFormatoTese() {
        let presencialCount = 0;
        let distanciaCount = 0;
        let totalMarcados = 0;

        // Percorre apenas os 5 membros Titulares
        for (let i = 1; i <= 5; i++) {
            const rPresencial = document.getElementById(`part${i}Presencial`);
            const rDistancia = document.getElementById(`part${i}Distancia`);

            if (rPresencial && rPresencial.checked) {
                presencialCount++;
                totalMarcados++;
            } else if (rDistancia && rDistancia.checked) {
                distanciaCount++;
                totalMarcados++;
            }
        }

        // Se ningu√©m foi marcado, retorna vazio para n√£o sujar a planilha
        if (totalMarcados === 0) return '';

        // Regra 1: TODOS Presenciais
        if (presencialCount === totalMarcados) return 'Presencial';

        // Regra 3: TODOS Dist√¢ncia
        if (distanciaCount === totalMarcados) return 'Dist√¢ncia';

        // Regra 2: Se houver mistura (pelo menos um dist√¢ncia + um presencial)
        return 'H√≠brido';
    }

/** ===============================
        ATUALIZANDO RESUMO FINAL
    =============================== */
    function atualizarResumoFinal() {
        console.log('üîÑ Atualizando dados do card de resumo...');
        
        // 1. Pega os dados salvos (ou um objeto vazio se n√£o houver nada)
        const dados = window.dadosAluno || {};

        // 2. Lista de mapeamento: [ID do HTML, Valor que vem do objeto]
        const campos = [
            ['resumoNome', dados.nome],
            ['resumoNrUsp', dados.nrUsp],
            ['resumoEmail', dados.emailAluno],
            ['resumoTitulo', dados.tituloTese]
        ];

        // 3. Alimenta cada campo com seguran√ßa
        campos.forEach(([id, valor]) => {
            const elemento = document.getElementById(id);
            if (elemento) {
                // Se o valor estiver vazio, coloca um tra√ßo para n√£o ficar feio
                elemento.textContent = valor || '-';
            } else {
                console.warn(`‚ö†Ô∏è Elemento ${id} n√£o encontrado no HTML.`);
            }
        });

        console.log('‚úÖ Card de resumo alimentado!');
    }

/** =============================================
      CONFER√äNCIA COMPLETA DOS DADOS
================================================ */
    const btnConferir = document.getElementById('btnConferir');
    const btnGravar = document.getElementById('btnGravarFinal');

    if (btnConferir) {
        btnConferir.addEventListener('click', function() {

            salvarDadosEtapa(4); // Garante que a etapa atual foi salva

            console.log("üì¶ ESTADO ATUAL DO OBJETO DADOSALUNO:", window.dadosAluno);

            const d = window.dadosAluno || {};
            
            // 1. Definimos quais campos s√£o obrigat√≥rios (IDs do objeto)
            const obrigatorios = {
                nome: "Nome Completo",
                nrUsp: "N¬∫ USP",
                emailAluno: "E-mail",
                tituloTese: "T√≠tulo da Tese"
            };

            let camposFaltando = [];

            // 2. O JS percorre o objeto verificando o que est√° vazio
            Object.keys(obrigatorios).forEach(chave => {
                if (!d[chave] || d[chave].trim() === "" || d[chave] === "-") {
                    camposFaltando.push(obrigatorios[chave]);
                }
            });

            // 2. Verifica√ß√£o especial para o ARQUIVO (Verifica o input diretamente)
            const inputArquivo = document.getElementById('arquivoPDF');
            if (!inputArquivo || !inputArquivo.files || inputArquivo.files.length === 0) {
                camposFaltando.push("Arquivo PDF da Tese/Disserta√ß√£o");
            }

            // 3. Verifica√ß√£o Final
            if (camposFaltando.length > 0) {
                // Se faltar algo, avisa e N√ÉO libera o bot√£o de gravar
                alert("‚ö†Ô∏è Aten√ß√£o! Os seguintes campos s√£o obrigat√≥rios e n√£o foram preenchidos:\n\n‚Ä¢ " + camposFaltando.join("\n‚Ä¢ "));
                console.warn("üö´ Confer√™ncia recusada: campos incompletos.");
            } else {
                // ... dentro da valida√ß√£o do bot√£o Conferir ...
                console.log("‚úÖ Campos validados. Abrindo modal de confer√™ncia...");
                
                // Mudamos o visual do bot√£o conferir para indicar que a valida√ß√£o passou
                this.innerHTML = '<i class="fas fa-eye me-2"></i> Revisando Dados...';
                this.classList.replace('btn-primary', 'btn-warning');

                // APENAS CHAMA O MODAL (N√£o libera o gravar ainda!)
                renderizarResumoNoModal();
            }
        });
    }

/** ========================
 FUN√á√ÉO OVERLAY DE LOADING
============================ */    
    function toggleLoading(show, texto = "Carregando...") {
        const overlay = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingTexto');
        if (txt) txt.textContent = texto;
        overlay.classList.toggle('d-none', !show);
        overlay.classList.toggle('d-flex', show);
    }

    function criarNotificacao(mensagem, titulo) {
        document.getElementById('mensagemNotificacao').textContent = mensagem;
        document.getElementById('tituloNotificacao').textContent = titulo;
        bootstrap.Toast.getOrCreateInstance(document.getElementById('notificacao')).show();
    }

    function criarNotificacaoOK(m, t) { criarNotificacao(m, t); definirIcone('bi-check2-square'); definirCor('--verde-sucesso'); }
    function criarNotificacaoErro(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-triangle-fill'); definirCor('--vermelho-feusp'); }
    function criarNotificacaoAdvertencia(m, t) { criarNotificacao(m, t); definirIcone('bi-exclamation-square'); definirCor('--amarelo'); }
    function definirIcone(c) { document.getElementById('iconeNotificacao').className = 'bi ' + c; }
    function definirCor(v) {
        let cor = getComputedStyle(document.documentElement).getPropertyValue(v).trim();
        document.getElementById('notificacao').style.backgroundColor = cor;
    }

/** ======================================================
     Mostra/Esconde campos de log√≠stica (Di√°ria/Passagem)
    ====================================================== */
    function toggleLogistica(id, mostrar) {
        const divLogistica = document.getElementById('logistica' + id);
        if (mostrar) {
            divLogistica.classList.remove('d-none');
        } else {
            divLogistica.classList.add('d-none');
            // Limpa as sele√ß√µes internas se esconder
            resetCamposLogistica(id);
        }
    }

/** ============================================
     Mostra/Esconde campo de Upload e Passagens
    ============================================ */
    function toggleUpload(id, mostrar) {
        const divUpload = document.getElementById('campoUpload' + id);
        if (mostrar) {
            divUpload.classList.remove('d-none');
        } else {
            divUpload.classList.add('d-none');
        }
    }

    function resetCamposLogistica(id) {
        document.getElementById('diaria' + id + 'Sim').checked = false;
        document.getElementById('diaria' + id + 'Nao').checked = false;
        document.getElementById('campoUpload' + id).classList.add('d-none');
    }

/**
 * Fun√ß√£o para capturar dados de uma etapa espec√≠fica
 * @param {number} etapa - O n√∫mero da etapa que o usu√°rio est√° saindo
 */
    function salvarDadosEtapa(etapa) {
        console.log(`üíæ Salvando dados da Etapa ${etapa}...`);
        
        if (etapa === 2) {
            window.dadosAluno.areaConcentracao = document.getElementById('areaConcentracao')?.value;
            window.dadosAluno.orientador = document.getElementById('orientador')?.value;
            // SEGUNDO TITULAR
            window.dadosAluno.nomeTitular2 = document.getElementById('nomeTitular2')?.value;
            window.dadosAluno.emailTitular2 = document.getElementById('emailTitular2')?.value;
            window.dadosAluno.vinculoTitular2 = document.getElementById('vinculoTitular2')?.value;
            // TERCEIRO TITULAR
            window.dadosAluno.nomeTitular3 = document.getElementById('nomeTitular3')?.value;
            window.dadosAluno.emailTitular3 = document.getElementById('emailTitular3')?.value;
            window.dadosAluno.vinculoTitular3 = document.getElementById('vinculoTitular3')?.value;
            // QUARTO TITULAR
            window.dadosAluno.nomeTitular4 = document.getElementById('nomeTitular4')?.value;
            window.dadosAluno.emailTitular4 = document.getElementById('emailTitular4')?.value;
            window.dadosAluno.vinculoTitular4 = document.getElementById('vinculoTitular4')?.value;
            // QUINTO TITULAR
            window.dadosAluno.nomeTitular5 = document.getElementById('nomeTitular5')?.value;
            window.dadosAluno.emailTitular5 = document.getElementById('emailTitular5')?.value;
            window.dadosAluno.vinculoTitular5 = document.getElementById('vinculoTitular5')?.value;

            // QUAL √â TIPO FORMATO DA DEFESA
            window.dadosAluno.tipoDefesa = calcularFormatoTese();
            
            console.log(`‚úÖ Formato definido como: ${window.dadosAluno.tipoDefesa}`);
        } 
        else if (etapa === 3) {
            // PRIMEIRO SUPLENTE
            window.dadosAluno.nomeSuplente1 = document.getElementById('nomeSuplente1')?.value;
            window.dadosAluno.emailSuplente1 = document.getElementById('emailSuplente1')?.value;
            window.dadosAluno.vinculoSuplente1 = document.getElementById('vinculoSuplente1')?.value;
            // SEGUNDO SUPLENTE
            window.dadosAluno.nomeSuplente2 = document.getElementById('nomeSuplente2')?.value;
            window.dadosAluno.emailSuplente2 = document.getElementById('emailSuplente2')?.value;
            window.dadosAluno.vinculoSuplente2 = document.getElementById('vinculoSuplente2')?.value;
            // TERCEIRO SUPLENTE
            window.dadosAluno.nomeSuplente3 = document.getElementById('nomeSuplente3')?.value;
            window.dadosAluno.emailSuplente3 = document.getElementById('emailSuplente3')?.value;
            window.dadosAluno.vinculoSuplente3 = document.getElementById('vinculoSuplente3')?.value;
            // QUARTO SUPLENTE
            window.dadosAluno.nomeSuplente4 = document.getElementById('nomeSuplente4')?.value;
            window.dadosAluno.emailSuplente4 = document.getElementById('emailSuplente4')?.value;
            window.dadosAluno.vinculoSuplente4 = document.getElementById('vinculoSuplente4')?.value;
            // QUINTO SUPLENTE
            window.dadosAluno.nomeSuplente5 = document.getElementById('nomeSuplente5')?.value;
            window.dadosAluno.emailSuplente5 = document.getElementById('emailSuplente5')?.value;
            window.dadosAluno.vinculoSuplente5 = document.getElementById('vinculoSuplente5')?.value;
        } 
        else if (etapa === 4) {
            const inputArquivo = document.getElementById('arquivoPDF');
            console.log("üîç Tentando capturar arquivo do input:", inputArquivo);
            
            // Verifica se existe um arquivo selecionado na lista de arquivos do input
            if (inputArquivo && inputArquivo.files && inputArquivo.files.length > 0) {
                // Pegamos o nome do primeiro arquivo da lista
                window.dadosAluno.arquivoPDF = inputArquivo.files[0].name;
            } else {
                window.dadosAluno.arquivoPDF = "N√£o selecionado";
            }
        }
        
        console.log('üìä Estado atual do objeto:', window.dadosAluno);
    }

/** =======================================
     Dentro da l√≥gica que abre o seu Modal
    ======================================= */
    function preencherModal() {
        const d = window.dadosAluno;
        
        // Injetando no HTML do seu novo arquivo modalResumoGeral.html
        document.getElementById('modal-nome').textContent = d.nome || 'N√£o informado';
        document.getElementById('modal-email').textContent = d.emailAluno || 'N√£o informado';
        // ... e assim por diante para todos os campos
    }

/** =======================
     RENDERIZANDO O MODAL
    ======================= */
    function renderizarResumoNoModal() {
        const d = window.dadosAluno || {};
        const container = document.getElementById('corpoResumoGeral');

        container.innerHTML = `
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle me-2"></i> Verifique se todas as informa√ß√µes abaixo est√£o corretas antes de finalizar.
                </div>
                
                <h6 class="fw-bold border-bottom pb-1 text-primary">1. IDENTIFICA√á√ÉO</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted">Nome:</td><td class="fw-bold">${d.nome || '-'}</td></tr>
                    <tr><td class="text-muted">N¬∫ USP:</td><td class="fw-bold">${d.nrUsp || '-'}</td></tr>
                    <tr><td width="30%" class="text-muted">E-mail:</td><td class="fw-bold">${d.emailAluno || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary">2. DADOS ACAD√äMICOS</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td class="text-muted">T√≠tulo:</td><td class="fw-bold">${d.tituloTese || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary">3. AGENDAMENTO</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted">Data Defesa:</td><td class="fw-bold">${d.dataAgenda || '-'}</td></tr>
                    <tr><td class="text-muted">Hora:</td><td class="fw-bold">${d.horaAgenda || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary">4. MEMBROS TITULARES</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted">√Årea de Concentra√ß√£o:</td><td class="fw-bold">${d.areaConcentracao || '-'}</td></tr>
                    <tr><td width="30%" class="text-muted">Orientador:</td><td class="fw-bold">${d.orientador || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">SEGUNDO TITULAR</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeTitular2 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailTitular2 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoTitular2 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">TERCEIRO TITULAR</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeTitular3 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailTitular3 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoTitular3 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">QUARTO TITULAR</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeTitular4 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailTitular4 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoTitular4 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">QUINTO TITULAR</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeTitular5 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailTitular5 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoTitular5 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary">5. MEMBROS SUPLENTES</h6>
                
                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasisy small mt-2">PRIMEIRO SUPLENTE</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeSuplente1 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailSuplente1 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoSuplente1 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">SEGUNDO SUPLENTE</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeSuplente2 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailSuplente2 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoSuplente2 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">TERCEIRO SUPLENTE</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeSuplente3 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailSuplente3 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoSuplente3 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">QUARTO SUPLENTE</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeSuplente4 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailSuplente4 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoSuplente4 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary-emphasis small">QUINTO SUPLENTE</h6>
                <table class="table table-sm table-borderless mb-3">
                    <tr><td width="30%" class="text-muted small">Nome:</td><td class="fw-bold">${d.nomeSuplente5 || '-'}</td></tr>
                    <tr><td class="text-muted small">E-mail:</td><td class="fw-bold">${d.emailSuplente5 || '-'}</td></tr>
                    <tr><td class="text-muted small">V√≠nculo:</td><td class="fw-bold">${d.vinculoSuplente5 || '-'}</td></tr>
                </table>

                <h6 class="fw-bold border-bottom pb-1 text-primary">6. ARQUIVO TESE/DISSERTA√á√ÉO</h6>
                <table class="table table-sm table-borderless mb-0">
                    <tr><td width="30%" class="text-muted">Arquivo:</td><td class="fw-bold">${d.arquivoPDF || 'N√£o selecionado'}</td></tr>
                </table>
            `;

        // Abre o modal ap√≥s renderizar
        new bootstrap.Modal(document.getElementById('modalConferencia')).show();
    }

/** ===========================================
    GERENCIADOR DE NAVEGA√á√ÉO GLOBAL (ROBUSTO)
=============================================== */
    document.addEventListener('click', function (event) {
        const id = event.target.id;

        // BOT√ïES DE PR√ìXIMO
        if (id === 'btn-proximo-etapa1') {
            console.log("‚û°Ô∏è Indo para Etapa 2");
            mostrarEtapa(2);
        } 
        else if (id === 'btn-proximo-etapa2') {
            console.log("‚û°Ô∏è Indo para Etapa 3");
            mostrarEtapa(3);
        } 
        else if (id === 'btn-proximo-etapa3') {
            console.log("‚û°Ô∏è Indo para Etapa 4 (Final)");
            if (typeof atualizarResumoFinal === "function") atualizarResumoFinal();
            mostrarEtapa(4);
        }

        // BOT√ïES DE VOLTAR
        else if (id === 'btn-voltar-etapa2') {
            console.log("‚¨ÖÔ∏è Voltando para Etapa 1");
            mostrarEtapa(1);
        } 
        else if (id === 'btn-voltar-etapa3') {
            console.log("‚¨ÖÔ∏è Voltando para Etapa 2");
            mostrarEtapa(2);
        }
        else if (id === 'btn-voltar-etapa4') {
            console.log("‚¨ÖÔ∏è Voltando para Etapa 3");
            mostrarEtapa(3);
        }
    });

/** ===================================================
    Ativa/Desativa o bot√£o conforme o checkbox da LGPD
======================================================= */
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'checkLGPD') {
            const btnConfirmar = document.getElementById('confirmarNoModal');
            if (btnConfirmar) {
                btnConfirmar.disabled = !e.target.checked;
            }
        }
    });

/** ===================================================
    VALIDAR E CONFIRMAR
======================================================= */
function validarEConfirmar() {
    // 1. Primeiro checa se a LGPD est√° marcada
    const lgpdAceite = document.getElementById('checkLGPD').checked; 
    
    if (!lgpdAceite) {
        Swal.fire('Ops!', 'Voc√™ precisa aceitar os termos da LGPD para continuar.', 'error');
        return;
    }

    // 2. Se a LGPD t√° ok, abre o modal instrutivo que criamos
    confirmarEnvioFinal(); 
}

function confirmarEnvioFinal() {
    Swal.fire({
        title: '',
        html: `
            <div style="background-color: #fff3cd; margin: -20px -1.6em 20px -1.6em; padding: 20px; border-bottom: 1px solid #ffeeba; border-radius: 5px 5px 0 0;">
                <h3 style="color: #856404; margin: 0; font-weight: bold;">
                    ‚ö†Ô∏è OBSERVA√á√ÉO IMPORTANTE
                </h3>
            </div>
            <div style="text-align: left; font-size: 0.95rem; line-height: 1.5;">
                <p>Este formul√°rio ser√° enviado automaticamente para o e-mail do(a) <b>orientador(a)</b> cadastrado.</p>
                <p><b>Aten√ß√£o aos pr√≥ximos passos:</b></p>
                <ol>
                    <li>O(A) orientador(a) dever√°, obrigatoriamente, realizar a <b>assinatura digital (GOV.BR)</b> no documento.</li>
                    <li>Ap√≥s assinar, o(a) orientador(a) deve encaminh√°-lo para <b>posfe@usp.br</b>.</li>
                </ol>
                <div style="background-color: #fff3cd; padding: 12px; border-radius: 5px; border-left: 5px solid #ffc107; margin-top: 15px;">
                    <b>Lembre-se:</b> A valida√ß√£o do dep√≥sito s√≥ ocorrer√° ap√≥s o recebimento do formul√°rio assinado enviado pelo(a) orientador(a).
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745', // Verde de "prosseguir"
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Estou ciente, enviar agora!',
        cancelButtonText: 'Revisar dados'
    }).then((result) => {
        if (result.isConfirmed) {
            // S√ì AQUI ele realmente dispara os dados para a planilha e e-mail
            executarEnvioParaGoogle(); 
        }
    });
}

/** ===================================================
    Empacotando dados e para envio ao Google Sheets
======================================================= */
function executarEnvioParaGoogle() {
    const dadosParaEnviar = window.dadosAluno;

    // 1. Mostra o loading (importante para o usu√°rio n√£o clicar de novo)
    Swal.fire({
        title: 'Processando Dep√≥sito',
        text: 'Gravando dados e enviando e-mail...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    // 2. Chama a grava√ß√£o na planilha
    google.script.run
      .withSuccessHandler(function(resposta) {
          console.log("Sucesso na planilha! Agora vou disparar o e-mail...");

            // 3. Chamamos o e-mail (tamb√©m no servidor)
            google.script.run
            .withSuccessHandler(function() {
                console.log("E-mail enviado! Agora carregando p√°gina de sucesso...");

                // 4. M√ÅGICA FINAL: Busca o HTML da p√°gina de sucesso para exibir
                google.script.run
                    .withSuccessHandler(function(htmlFinal) {
                        Swal.close();
                        
                    // ‚úÖ FOR√áA SCROLL E BARRA ANTES de recarregar
                    window.scrollTo(0, 0);
                    document.body.style.overflowY = 'scroll !important';
                    document.documentElement.style.overflowY = 'scroll !important';
                    document.body.style.minHeight = '101vh';
                        // --- AJUSTES AQUI ---
                        // 1. Usamos innerHTML no body para evitar o erro de Syntax/Identifier
                        document.body.innerHTML = htmlFinal;

                        window.scrollTo(0, 0);
                        document.body.style.overflowY = 'scroll';

                    })
                    .carregarPaginaSucesso(dadosParaEnviar);
            })
            .enviarEmailConfirmacao(dadosParaEnviar); // Nome da fun√ß√£o de e-mail no .gs
      })
      .withFailureHandler(function(erro) {
          Swal.fire("Erro Cr√≠tico", erro.toString(), "error");
      })
      .salvarDadosNaPlanilha(dadosParaEnviar);
}

</script>